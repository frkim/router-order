{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "6514908240370212134"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the environment that can be used as part of resource names"
      }
    },
    "location": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Primary location for all resources"
      }
    },
    "apimPublisherEmail": {
      "type": "string",
      "metadata": {
        "description": "Email address of the APIM publisher"
      }
    },
    "apimPublisherName": {
      "type": "string",
      "metadata": {
        "description": "Name of the APIM publisher"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "logicApp": "logic-",
      "insightsComponents": "appi-",
      "storageAccountWorkflows": "staflow",
      "logAnalyticsWorkspaces": "log-",
      "serviceBusNamespace": "sb-",
      "apiManagementService": "apim-"
    },
    "abbrs": "[variables('$fxv#0')]",
    "tags": {
      "azd-env-name": "[parameters('environmentName')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[format('rg-{0}', parameters('environmentName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "workflow-storage",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').storageAccountWorkflows, replace(parameters('environmentName'), '-', ''))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10629967471547449015"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "defaultToOAuthAuthentication": true,
                "minimumTlsVersion": "TLS1_2"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "blobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2022-05-01').primaryEndpoints.blob]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('name'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2022-05-01').keys[0].value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "servicebus",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').serviceBusNamespace, parameters('environmentName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3604347662142321779"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-01-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'topic-customer-orders')]",
              "properties": {
                "enablePartitioning": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'topic-router-orders')]",
              "properties": {
                "enablePartitioning": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'notification')]",
              "properties": {
                "deadLetteringOnMessageExpiration": true,
                "maxSizeInMegabytes": 1024,
                "maxDeliveryCount": 10,
                "enablePartitioning": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'topic-customer-orders', 'sub-order-stock')]",
              "properties": {
                "deadLetteringOnMessageExpiration": true,
                "maxDeliveryCount": 10
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('name'), 'topic-customer-orders')]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'topic-router-orders', 'sub-order-router')]",
              "properties": {
                "deadLetteringOnMessageExpiration": true,
                "maxDeliveryCount": 10
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('name'), 'topic-router-orders')]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions/rules",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('name'), 'topic-router-orders', 'sub-order-router', 'InstockFalseFilter')]",
              "properties": {
                "correlationFilter": {
                  "properties": {
                    "instock": "false"
                  }
                },
                "filterType": "CorrelationFilter"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', parameters('name'), 'topic-router-orders', 'sub-order-router')]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'topic-router-orders', 'sub-tech-schedule')]",
              "properties": {
                "deadLetteringOnMessageExpiration": true,
                "maxDeliveryCount": 10
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('name'), 'topic-router-orders')]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions/rules",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('name'), 'topic-router-orders', 'sub-tech-schedule', 'InstockTrueFilter')]",
              "properties": {
                "correlationFilter": {
                  "properties": {
                    "instock": "true"
                  }
                },
                "filterType": "CorrelationFilter"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', parameters('name'), 'topic-router-orders', 'sub-tech-schedule')]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "fullyQualifiedNamespace": {
              "type": "string",
              "value": "[format('{0}.servicebus.windows.net', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "applicationinsights",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').insightsComponents, parameters('environmentName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[format('{0}{1}', variables('abbrs').logAnalyticsWorkspaces, parameters('environmentName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3215436237038490325"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of Application Insights"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location to deploy the resource"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to add to resources"
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1,
                  "legacy": 0,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "apim",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').apiManagementService, parameters('environmentName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "publisherEmail": {
            "value": "[parameters('apimPublisherEmail')]"
          },
          "publisherName": {
            "value": "[parameters('apimPublisherName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1989996654133969894"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "publisherEmail": {
              "type": "string",
              "metadata": {
                "description": "Email address of the publisher"
              }
            },
            "publisherName": {
              "type": "string",
              "metadata": {
                "description": "Name of the publisher"
              }
            }
          },
          "variables": {
            "$fxv#0": "openapi: 3.1.0\ninfo:\n  title: Stock Management\n  description: ''\n  version: '1.0'\npaths:\n  /router-stock:\n    get:\n      summary: Get router stock\n      description: Get router stock status\n      operationId: get-router-stock\n      parameters:\n        - name: model\n          in: query\n          required: true\n          schema:\n            type: string\n          example: Pro Router V5\n      responses:\n        '200':\n          description: ''\n          content:\n            application/json:\n              schema:\n                $ref: '#/components/schemas/Stock_Status_Response'\n              example:\n                inventory:\n                  lastUpdated: '[LAST_UPDATED]'\n                  items:\n                    - model: Pro Router V5\n                      quantity: 0\n                      status: Out of Stock\ncomponents:\n  schemas:\n    Stock_Status_Request:\n      type: object\n      properties:\n        model:\n          type: string\n          description: The router model to check stock for\n      required:\n        - model\n      x-apim-schema-name: Stock Status Request\n    Stock_Status_Response:\n      type: object\n      properties:\n        inventory:\n          type: object\n          properties:\n            lastUpdated:\n              type: string\n            items:\n              type: array\n              items:\n                required:\n                  - model\n                  - quantity\n                  - status\n                type: object\n                properties:\n                  model:\n                    type: string\n                  quantity:\n                    type: integer\n                  status:\n                    type: string\n      x-apim-schema-name: Stock Status Response\n  securitySchemes:\n    apiKeyHeader:\n      type: apiKey\n      name: Ocp-Apim-Subscription-Key\n      in: header\n    apiKeyQuery:\n      type: apiKey\n      name: subscription-key\n      in: query\nsecurity:\n  - apiKeyHeader: [ ]\n  - apiKeyQuery: [ ]"
          },
          "resources": [
            {
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "BasicV2",
                "capacity": 1
              },
              "properties": {
                "publisherEmail": "[parameters('publisherEmail')]",
                "publisherName": "[parameters('publisherName')]"
              }
            },
            {
              "type": "Microsoft.ApiManagement/service/products",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'router-order')]",
              "properties": {
                "displayName": "Router Order",
                "description": "Product for Router Order operations",
                "subscriptionRequired": true,
                "approvalRequired": false,
                "state": "published"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/apis",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'stock-management')]",
              "properties": {
                "displayName": "Stock Management API",
                "path": "stock-management",
                "protocols": [
                  "https"
                ],
                "format": "openapi",
                "value": "[variables('$fxv#0')]",
                "subscriptionRequired": true,
                "subscriptionKeyParameterNames": {
                  "header": "Ocp-Apim-Subscription-Key",
                  "query": "subscription-key"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/apis/policies",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'stock-management', 'policy')]",
              "properties": {
                "value": "<policies>\n    <inbound>\n        <base />\n        <mock-response status-code=\"200\" content-type=\"application/json\" />\n    </inbound>\n    <backend>\n        <base />\n    </backend>\n    <outbound>\n        <base />\n    </outbound>\n    <on-error>\n        <base />\n    </on-error>\n</policies>",
                "format": "xml"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('name'), 'stock-management')]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/products/apis",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'router-order', 'stock-management')]",
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/products', parameters('name'), 'router-order')]",
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('name'), 'stock-management')]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/subscriptions",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'router-order-subscription')]",
              "properties": {
                "displayName": "Router Order Subscription",
                "scope": "[resourceId('Microsoft.ApiManagement/service/products', parameters('name'), 'router-order')]",
                "state": "active"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]",
                "[resourceId('Microsoft.ApiManagement/service/products', parameters('name'), 'router-order')]"
              ]
            },
            {
              "type": "Microsoft.ApiManagement/service/schemas",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'order-schema')]",
              "properties": {
                "schemaType": "json",
                "document": {
                  "value": {
                    "type": "object",
                    "properties": {
                      "order": {
                        "type": "object",
                        "properties": {
                          "orderId": {
                            "type": "string"
                          },
                          "orderDate": {
                            "type": "string"
                          },
                          "customer": {
                            "type": "object",
                            "properties": {
                              "accountType": {
                                "type": "string"
                              },
                              "companyName": {
                                "type": "string"
                              },
                              "contactPerson": {
                                "type": "object",
                                "properties": {
                                  "firstName": {
                                    "type": "string"
                                  },
                                  "lastName": {
                                    "type": "string"
                                  },
                                  "email": {
                                    "type": "string"
                                  },
                                  "jobTitle": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "firstName",
                                  "lastName",
                                  "email",
                                  "jobTitle"
                                ]
                              },
                              "billingAddress": {
                                "type": "object",
                                "properties": {
                                  "street": {
                                    "type": "string"
                                  },
                                  "city": {
                                    "type": "string"
                                  },
                                  "postalCode": {
                                    "type": "string"
                                  },
                                  "country": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "street",
                                  "city",
                                  "postalCode",
                                  "country"
                                ]
                              }
                            },
                            "required": [
                              "accountType",
                              "companyName",
                              "contactPerson",
                              "billingAddress"
                            ]
                          },
                          "contractDetails": {
                            "type": "object",
                            "properties": {
                              "contractId": {
                                "type": "string"
                              },
                              "servicePlan": {
                                "type": "string"
                              },
                              "commitmentPeriod": {
                                "type": "string"
                              },
                              "monthlyFee": {
                                "type": "number"
                              }
                            },
                            "required": [
                              "contractId",
                              "servicePlan",
                              "commitmentPeriod",
                              "monthlyFee"
                            ]
                          },
                          "product": {
                            "type": "object",
                            "properties": {
                              "type": {
                                "type": "string"
                              },
                              "model": {
                                "type": "string"
                              },
                              "version": {
                                "type": "string"
                              },
                              "features": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              },
                              "quantity": {
                                "type": "integer"
                              },
                              "unitPrice": {
                                "type": "integer"
                              }
                            },
                            "required": [
                              "type",
                              "model",
                              "version",
                              "features",
                              "quantity",
                              "unitPrice"
                            ]
                          },
                          "delivery": {
                            "type": "object",
                            "properties": {
                              "method": {
                                "type": "string"
                              },
                              "trackingNumber": {
                                "type": "string"
                              },
                              "estimatedDeliveryDate": {
                                "type": "string"
                              },
                              "deliveryAddress": {
                                "type": "object",
                                "properties": {
                                  "street": {
                                    "type": "string"
                                  },
                                  "city": {
                                    "type": "string"
                                  },
                                  "postalCode": {
                                    "type": "string"
                                  },
                                  "country": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "street",
                                  "city",
                                  "postalCode",
                                  "country"
                                ]
                              },
                              "deliveryInstructions": {
                                "type": "string"
                              }
                            },
                            "required": [
                              "method",
                              "trackingNumber",
                              "estimatedDeliveryDate",
                              "deliveryAddress",
                              "deliveryInstructions"
                            ]
                          },
                          "payment": {
                            "type": "object",
                            "properties": {
                              "method": {
                                "type": "string"
                              },
                              "poNumber": {
                                "type": "string"
                              },
                              "totalPrice": {
                                "type": "integer"
                              },
                              "installationFee": {
                                "type": "integer"
                              },
                              "discount": {
                                "type": "object",
                                "properties": {
                                  "type": {
                                    "type": "string"
                                  },
                                  "amount": {
                                    "type": "integer"
                                  },
                                  "description": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "type",
                                  "amount",
                                  "description"
                                ]
                              }
                            },
                            "required": [
                              "method",
                              "poNumber",
                              "totalPrice",
                              "installationFee",
                              "discount"
                            ]
                          }
                        },
                        "required": [
                          "orderId",
                          "orderDate",
                          "customer",
                          "contractDetails",
                          "product",
                          "delivery",
                          "payment"
                        ]
                      }
                    },
                    "required": [
                      "order"
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "gatewayUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('name')), '2024-06-01-preview').gatewayUrl]"
            },
            "subscriptionKey": {
              "type": "string",
              "value": "[listSecrets(format('{0}/providers/Microsoft.ApiManagement/service/{1}/subscriptions/router-order-subscription', resourceGroup().id, parameters('name')), '2022-08-01').primaryKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logicapp",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').logicApp, parameters('environmentName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'applicationinsights'), '2025-04-01').outputs.applicationInsightsConnectionString.value]"
          },
          "workflowStorageConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'workflow-storage'), '2025-04-01').outputs.connectionString.value]"
          },
          "serviceBusNamespace": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus'), '2025-04-01').outputs.fullyQualifiedNamespace.value]"
          },
          "apimSubscriptionKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'apim'), '2025-04-01').outputs.subscriptionKey.value]"
          },
          "abbrs": {
            "value": "[variables('abbrs')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14295921016454326367"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "workflowStorageConnectionString": {
              "type": "string"
            },
            "serviceBusNamespace": {
              "type": "string"
            },
            "apimSubscriptionKey": {
              "type": "string"
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the environment that can be used as part of resource names"
              }
            },
            "abbrs": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[format('plan-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "WS1",
                "tier": "WorkflowStandard"
              },
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,workflowapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-{0}', parameters('name')))]",
                "httpsOnly": true,
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "APP_KIND",
                      "value": "workflowApp"
                    },
                    {
                      "name": "AzureFunctionsJobHost__extensionBundle__id",
                      "value": "Microsoft.Azure.Functions.ExtensionBundle.Workflows"
                    },
                    {
                      "name": "AzureFunctionsJobHost__extensionBundle__version",
                      "value": "[1.*, 2.0.0)"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('applicationInsightsConnectionString')]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[parameters('workflowStorageConnectionString')]"
                    },
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[parameters('workflowStorageConnectionString')]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(parameters('name'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "dotnet"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~18"
                    },
                    {
                      "name": "apiManagement_ApiId",
                      "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.ApiManagement/service/{2}{3}/apis/stock-management', subscription().subscriptionId, resourceGroup().name, parameters('abbrs').apiManagementService, parameters('environmentName'))]"
                    },
                    {
                      "name": "apiManagement_SubscriptionKey",
                      "value": "[parameters('apimSubscriptionKey')]"
                    },
                    {
                      "name": "apiManagement_BaseUrl",
                      "value": "[format('https://{0}{1}.azure-api.net/stock-management', parameters('abbrs').apiManagementService, parameters('environmentName'))]"
                    },
                    {
                      "name": "routerOrderApiUrl",
                      "value": "[format('https://{0}.azurewebsites.net', parameters('name'))]"
                    },
                    {
                      "name": "serviceBus_fullyQualifiedNamespace",
                      "value": "[parameters('serviceBusNamespace')]"
                    }
                  ],
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com"
                    ]
                  },
                  "use32BitWorkerProcess": false,
                  "ftpsState": "Disabled"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-{0}', parameters('name')))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-03-01').defaultHostName]"
            },
            "identityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-03-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'apim')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'applicationinsights')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'workflow-storage')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sb-sender-role-assignment",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'logicapp'), '2025-04-01').outputs.identityPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39"
          },
          "targetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus'), '2025-04-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17471346788059101920"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string"
            },
            "roleDefinitionId": {
              "type": "string",
              "allowedValues": [
                "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
                "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0"
              ]
            },
            "targetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('targetId'), parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'logicapp')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sb-receiver-role-assignment",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'logicapp'), '2025-04-01').outputs.identityPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0"
          },
          "targetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus'), '2025-04-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17471346788059101920"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string"
            },
            "roleDefinitionId": {
              "type": "string",
              "allowedValues": [
                "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
                "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0"
              ]
            },
            "targetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('targetId'), parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'logicapp')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'servicebus')]"
      ]
    }
  ],
  "outputs": {
    "AZURE_LOCATION": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "AZURE_SUBSCRIPTION_ID": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "AZURE_TENANT_ID": {
      "type": "string",
      "value": "[tenant().tenantId]"
    },
    "AZURE_RESOURCE_GROUP": {
      "type": "string",
      "value": "[format('rg-{0}', parameters('environmentName'))]"
    }
  }
}